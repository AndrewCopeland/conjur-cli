#!/usr/bin/env ruby

require 'json'
require 'methadone'

class JsonField
  include Methadone::Main
  include Methadone::CLILogging

  description "parse JSON and extract a field value"
  arg :json_path, "path to object to extract, eg. 'headers.0' or 'document.author.name'"
  arg :json, :optional, "data to parse (reads from stdin if not given)"

  main do |path, input = nil|
    input ||= STDIN.read
    data = JSON.parse input
    result = data.instance_eval massage_path(path)
    puts result
  end
end

# massage object path to support .<digit> syntax
def massage_path path
  path.gsub /\.(\d+)/, '[\1]'
end

class Hash
  def method_missing label
    self[label] || self[label.to_s] || super
  end
end

JsonField.go!
